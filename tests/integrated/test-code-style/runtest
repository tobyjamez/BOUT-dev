#!/bin/bash

BOUT_TOP=../../..
error=

paths="$BOUT_TOP/src $BOUT_TOP/include $BOUT_TOP/examples"
for i in BoutReal # double float int char size_t
do
    grep -E "\([^\)]*const[^\(,:<]*$i[^,\):\*>]*\&"  -r --include=*xx $paths &&
    error=yes &&
    echo "const $i should be passed by value"
done
#for emacs regexp: \([,\(]\)[[:space:]]*const[[:space:]]+\([A-Za-z]+\)[[:space:]]+\([A-Za-z0-9]+\)[[:space:]]*\([,\)]\) â†’ \1\2 \3\4)
grep [\(,][[:space:]]*const[[:space:]][[:alnum:]]*[[:space:]][[:alnum:]]*[[:space:]]*[,\)] -r --include=*hxx $paths -n &&
    error=yes &&
    echo "Declaration of functions shouldn't declare pass-by-value as const"


GIT=git
for autogen in include/derivs.hxx
do
    if $GIT status &>/dev/null
    then
        if ! $GIT diff --exit-code $BOUT_TOP/$autogen &> /dev/null
        then
            error=1
            echo "$autogen changed - but should be autogenerated"
        fi
        if ! test "$error"
        then
            make -C $BOUT_TOP/${autogen%/*} --no-print-directory
        fi
        if ! $GIT diff --exit-code $BOUT_TOP/$autogen &> /dev/null
        then
            error=1
            echo "$autogen changed upon recreation"
            echo "Checking file out - to prevent further changes"
            $GIT checkout $BOUT_TOP/$autogen
        fi
    fi
done

# Check that exceptions are caught by reference
paths="src include examples tests"
for path in $paths
do
    catch_errors=$(grep catch[^\(]*\([^\(]*Bout $BOUT_TOP/$path --include=*xx -r|grep -v '&')
    ex=$?
    if test $ex -eq 0
    then
        error=yes
        echo "Found catch by value - not by reference:"
        echo "$catch_errors"
    fi
done


# Return
if test $error
then
    echo "-> Errors listed above"
    exit 1
else
    echo "No Errors detected"
    exit 0
fi
